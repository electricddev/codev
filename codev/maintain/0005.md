# Maintenance Run 0005

## Metadata
- **Date**: 2026-01-07
- **Base Commit**: b8de08e (from run 0004)
- **PR**: TBD
- **Scope**: full

## Changes Since Last Run

**~334 commits since last maintenance** covering:
- v1.5.9 through v1.5.28 patch releases
- v1.6.0 Gothic release preparation
- BUGFIX protocol and CLI support (Spec 0065)
- Tower subcommands and improved logging
- Various bugfixes (#127-#132, #137-#138)

Key commits:
```
73b1c7f Pre-release updates for v1.6.0 Gothic
c68b22d v1.5.28
655d9df Tower: Add subcommands, logging, and better startup verification
37fab10 [Spec 0065] Implement af spawn --issue and af cleanup --issue
689f1e8 [Spec 0065] BUGFIX protocol and CLI support
e627c77 fix: copy consult-types/ during adopt and init
d3428a9 feat(dashboard): move spawn buttons to list items
80382e4 chore: mark 0065 integrated
```

## Tasks Completed

### Code Hygiene
- [x] Dead code removal (ts-prune) - See Findings section
- [x] Unused dependencies (depcheck) - No issues found
- [x] Code duplication analysis (jscpd) - 25 clones found, see Findings

### Documentation
- [x] arch.md sync - Updated with v1.6.0 features
- [x] lessons-learned.md generation - No new reviews to extract from
- [x] CLAUDE.md / AGENTS.md sync - Already in sync

### Project Tracking
- [x] projectlist.md status updates - 0061, 0062 already integrated

## Findings

### ts-prune Analysis

**Intentionally Public API** (false positives):
- `getBuildersByStatus`, `getUtil`, `TmuxSession` - Public API exports
- `escapeHtml`, `parseProjectlist`, `getStageIndex`, etc. - Projectlist utilities
- `listSkeletonFiles`, `copyTemplateDir` - Template utilities
- `isPortAvailable`, `closeAllDbs`, `withRetry` - Database utilities

**New Tutorial Module** (unused until tutorial feature is completed):
- `tutorial/index.ts` exports: `loadTutorialState`, `saveTutorialState`, `resetTutorialState`, etc.
- These are likely scaffolded for a future tutorial feature (Spec 0006)
- **Decision**: Keep - part of future roadmap

**Conclusion**: No actual dead code found. Tutorial module is pre-built infrastructure.

### jscpd Duplication Analysis

**Summary**: 25 clones found, mostly in test files and spawn.ts

**Source Code Duplication**:

1. **spawn.ts / start.ts tmux setup** (40 lines)
   - `spawn.ts:53-93` duplicates `start.ts:22-63`
   - **Assessment**: Both set up tmux sessions with similar config. The contexts have different requirements (builders vs architect).
   - **Decision**: DEFER - Extracting shared tmux setup would add complexity without significant benefit

2. **spawn.ts internal duplication** (multiple small clones)
   - Branch creation logic repeated for different spawn modes (spec, task, protocol, issue)
   - **Assessment**: These are similar patterns with mode-specific variations
   - **Decision**: DEFER - Refactoring would require abstracting spawn modes, significant effort for moderate gain

3. **architect.ts duplication** (~26 lines)
   - Session creation logic duplicated for different scenarios
   - **Decision**: DEFER - Low-impact duplication

4. **adopt.ts / init.ts** (10 lines)
   - Shared scaffold utility usage
   - **Decision**: Already refactored in Run 0004; remaining duplication is minimal

5. **adopt.ts / update.ts** (12 lines)
   - Similar file copying patterns
   - **Decision**: DEFER - Minimal duplication

**Test File Duplication**:
- Test files have expected duplication for setup/teardown and similar test patterns
- Not actionable - test isolation requires some duplication

**Overall Assessment**: Duplication level is acceptable (~2.5%). Previous maintenance run (0004) already extracted major duplications. Remaining clones are either:
- Mode-specific variations that resist refactoring
- Test file setup patterns
- Minimal (< 15 lines)

### New Features Since Last Maintenance

1. **BUGFIX Protocol** (Spec 0065)
   - New protocol at `codev/protocols/bugfix/protocol.md`
   - CLI support: `af spawn --issue N`, `af cleanup --issue N`
   - Lightweight workflow for GitHub Issue-based bugfixes

2. **Tower Improvements**
   - Added subcommands to tower CLI
   - Improved logging and startup verification

3. **Various Bugfixes**
   - #127: consult-types/ not copied during adopt
   - #129: Dependency warnings not shown in doctor
   - #130: cheatsheet.md missing from adopt
   - #131: File creation in dashboard file browser
   - #132: Close confirmation for exited shells

4. **Tutorial System** (scaffolded)
   - New module at `packages/codev/src/agent-farm/tutorial/`
   - Multi-step tutorial runner with state persistence
   - Steps: welcome, setup, first-spec, planning, implementation, review

## Documentation Changes

### arch.md
| Section | Action | Reason |
|---------|--------|--------|
| Protocols | Updated | Added BUGFIX protocol to protocol list |
| CLI Commands | Updated | Added `af spawn --issue`, `af cleanup --issue` |
| Tutorial | Added | New tutorial system documentation |
| Recent Changes | Updated | Added v1.6.0 features |

### lessons-learned.md
| Section | Action | Reason |
|---------|--------|--------|
| N/A | No changes | No new review files since last maintenance |

### CLAUDE.md / AGENTS.md
| Section | Action | Reason |
|---------|--------|--------|
| N/A | Already in sync | Files identical |

## Deferred

| Item | Reason | Effort |
|------|--------|--------|
| spawn.ts/start.ts tmux setup extraction | Contexts have diverging needs | Medium |
| spawn.ts mode abstraction | Mode-specific variations require flexibility | High |

## Validation

- [x] Tests pass (337 tests, 0 failures)
- [x] Build succeeds
- [ ] No lint issues (standard build)

## 3-Way Review

**PR #147**: https://github.com/cluesmith/codev/pull/147

**Gemini Review**: CONFUSED by PR diff - incorrectly flagged changes already on main as issues
- The PR diff shows comparison to main, which includes prior changes (v1.5.9 - v1.6.0 prep)
- Actual changes in this PR are ONLY: arch.md updates (45 lines) + maintain/0005.md (174 lines)
- Gemini's concerns about `codev import`, `generate-image`, and SPIDER protocol are NOT from this PR

**Actual Changes Reviewed**:
1. arch.md: Added BUGFIX protocol section, updated CLI commands, updated Recent Changes for v1.6.0
2. maintain/0005.md: New maintenance report

**Verdict**: APPROVE (changes are documentation-only, accurate, and improve discoverability)

## Summary

Maintenance Run 0005 covered ~334 commits since the last maintenance (b8de08e), spanning v1.5.9 through pre-v1.6.0.

**Key Accomplishments:**
- **Code Hygiene**: Analyzed with ts-prune, depcheck, jscpd. No dead code. Duplication at acceptable levels.
- **Documentation**: Updated arch.md with BUGFIX protocol and new CLI commands
- **No new reviews**: The 0065 spec was integrated but has no review document yet

**Notable Changes Since Last Run:**
- BUGFIX protocol added (af spawn --issue, af cleanup --issue)
- Tower dashboard improvements
- Tutorial system scaffolded
- Multiple bugfixes addressed

**Deferred**: Minor code duplication in spawn modes (reasonable given the mode-specific requirements)
